<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ReelShort</title>

<style>
body{margin:0;background:#0b0b0f;color:white;font-family:Poppins}
header{display:flex;justify-content:space-between;padding:16px 5%;align-items:center}
.hero{height:60vh;position:relative;background:#000;display:flex;align-items:flex-end;padding:40px 5%}
.hero video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.hero-content{position:relative;z-index:2}
.section{padding:20px 5%}
.scroll-row{display:flex;gap:14px;overflow-x:auto}
.card{min-width:150px;background:#14141c;border-radius:10px;overflow:hidden;cursor:pointer}
.card img{width:100%;height:200px;object-fit:cover}
.card-title{padding:8px;font-size:13px;text-align:center}
.details{display:none;padding:20px 5%}
video{width:100%;border-radius:8px}
.ep-btn{background:#1e1e27;padding:8px;margin:4px;display:inline-block;cursor:pointer;border-radius:4px}
.ep-btn.playing{background:#E50914}
button{background:#E50914;border:none;padding:8px 14px;color:white;border-radius:4px;cursor:pointer}
</style>
</head>

<body>

<header>
<h2>ReelShort</h2>
<button onclick="goHome()">Home</button>
</header>

<div id="home">

<div class="hero">
<video id="heroVideo" muted autoplay loop></video>
<div class="hero-content">
<h2 id="heroTitle"></h2>
<button onclick="playHero()">Tonton</button>
</div>
</div>

<div class="section">
<h3>For You</h3>
<div class="scroll-row" id="feedRow"></div>
</div>

</div>

<div id="details" class="details">
<button onclick="goHome()">‚Üê Back</button>
<video id="player" controls></video>
<div id="episodes"></div>
</div>

<script>

const API="/api/proxy";
let currentBook=null;
let currentChapters=[];

/* API CALL */
async function apiCall(endpoint){
const res = await fetch(`${API}?url=${encodeURIComponent("https://captain.sapimu.au/reelshort"+endpoint)}`);
return res.json();
}

/* LOAD FEED */
async function loadFeed(){

const res = await apiCall("/api/v1/feed/1");

if(!res || res.code !== 200){
console.log("Feed error", res);
return;
}

const list = res.data;
if(!list || !list.length) return;

const hero = list[0];
currentBook = hero;

document.getElementById("heroTitle").textContent = hero.name || hero.title;
document.getElementById("feedRow").innerHTML="";

list.forEach(item=>{
const card=document.createElement("div");
card.className="card";
card.innerHTML=`
<img src="${item.cover}">
<div class="card-title">${item.name || item.title}</div>
`;
card.onclick=()=>openDetails(item.id);
document.getElementById("feedRow").appendChild(card);
});

loadHeroPreview(hero.id);
}

/* HERO PREVIEW */
async function loadHeroPreview(bookId){

const chapters = await apiCall(`/api/v1/book/${bookId}/chapters`);
if(!chapters?.data?.length) return;

currentChapters = chapters.data;
const first = currentChapters[0];

const encoded = encodeURIComponent(first.pageUrl || first.playUrl);

document.getElementById("heroVideo").src = `/api/reelshort/watch?url=${encoded}`;
}

/* PLAY HERO */
function playHero(){
if(currentBook){
openDetails(currentBook.id);
}
}

/* OPEN DETAILS */
async function openDetails(bookId){

document.getElementById("home").style.display="none";
document.getElementById("details").style.display="block";

currentBook = bookId;

const chapters = await apiCall(`/api/v1/book/${bookId}/chapters`);
if(!chapters?.data?.length) return;

currentChapters = chapters.data;

const wrap=document.getElementById("episodes");
wrap.innerHTML="";

currentChapters.forEach((ch,index)=>{
const btn=document.createElement("div");
btn.className="ep-btn";
btn.textContent = index+1;
btn.onclick=()=>playEpisode(index);
wrap.appendChild(btn);
});

playEpisode(0);
}

/* PLAY EPISODE (FIXED STREAM) */
function playEpisode(index){

const player=document.getElementById("player");

document.querySelectorAll(".ep-btn").forEach(btn=>btn.classList.remove("playing"));
document.querySelectorAll(".ep-btn")[index].classList.add("playing");

const episode = currentChapters[index];

const encoded = encodeURIComponent(episode.pageUrl || episode.playUrl);

player.pause();
player.src="";
player.load();

player.src = `/api/reelshort/watch?url=${encoded}`;

player.onloadedmetadata = ()=>{
player.play().catch(()=>{});
};
}

/* GO HOME */
function goHome(){
document.getElementById("details").style.display="none";
document.getElementById("home").style.display="block";
document.getElementById("player").pause();
}

loadFeed();

</script>
</body>
</html>
